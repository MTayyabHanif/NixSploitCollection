# CVE-2015-8660 OverlayFS

CVE-2015-8660 Linux kernel: Permission bypass on overlayfs during `copy_up`


### Overview

The `ovl_setattr` function in `fs/overlayfs/inode.c` in the Linux kernel through **4.3.3** attempts to merge distinct `setattr` operations, which allows local users to bypass intended access restrictions and modify the attributes of arbitrary overlay files via a crafted application.

[fs/overlayfs/inode.c](https://github.com/torvalds/linux/blob/master/fs/overlayfs/inode.c)

```cpp
int ovl_setattr(struct dentry *dentry, struct iattr *attr)
{
	int err;
	struct dentry *upperdentry;

	err = ovl_want_write(dentry);
	if (err)
		goto out;

	err = ovl_copy_up(dentry);
	if (!err) {
		upperdentry = ovl_dentry_upper(dentry);

		mutex_lock(&upperdentry->d_inode->i_mutex);
		err = notify_change(upperdentry, attr, NULL);
		mutex_unlock(&upperdentry->d_inode->i_mutex);
	}
	ovl_drop_write(dentry);
out:
	return err;
}
```

### References

[RedHat Bugzilla](https://access.redhat.com/security/cve/cve-2015-8660)

[Mitre CVE entry](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8660)

[OSS-security mail list announce](http://www.openwall.com/lists/oss-security/2015/12/23/5)

[CVE-2015-8660 Linux Kernel OverLay Fail @ youtube](https://www.youtube.com/watch?v=sfC2hbLlfWI)

[Kernel Documentation:overlayfs.txt](https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt)


### OverlayFS

Partially based on https://askubuntu.com/questions/109413/how-do-i-use-overlayfs

The main documentation is available in [Documentation/overlayfs.txt](https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt). It is also available in the linux-doc package in [/usr/share/doc/linux-doc/filesystems/overlayfs.txt.gz](/usr/share/doc/linux-doc/filesystems/overlayfs.txt.gz).

As the actual help documentation is more of a "how it works" instead of a "how to mount with it," here's a brief rundown (there is one example in the kernel documentation):

```bash
mount -t overlayfs -o [mount options] overlayfs [mountpoint for merged system]
```

Where `[mount options]` can be:

* `lowerdir=somedir`: lowerdir is the directory you're going to lay your new filesystem over, if there are duplicates these get overwritten by (actually, hidden in favor of) upperdir's version

* `upperdir=somedir`: upperdir is the directory you want to overlay lowerdir with. If duplicate filenames exist in lowerdir and upperdir, upperdir's version takes precedence.

* `standard mount options`. The only one I've seen from code is ro/rw, but you can experiment.

Note: mounting an overlayfs does not actually mount a filesystem. I was trying to mount a squashfs filesystem using an overlayfs mount, but that's not how it works. You must first mount the (in my case squashfs) filesystem to an arbitrary directory, then use overlayfs to merge the mount point (a directory) and another directory onto a tertiary directory (the overlayfs mount point)(edit: this "tertiary" directory can actually be the `upperdir=` directory). The tertiary directory is where you will see the merged filesystems (or directory trees - it's flexible).


### Example 1, overlaying the root filesystem

Ubuntu hybrid boot disk where the base Ubuntu system exists as `filesystem.squashfs` and files called `ubuntu.overlay` `kubuntu.overlay` `xubuntu.overlay` and `lubuntu.overlay`. The `.overlay` files are base installs of said systems with the contents of `filesystem.squashfs` pruned (to save space). Note that the init scripts should be modified to overlay the correct distro's `.overlay` file (from a boot parameter) using overlayfs and the above options and it works like a charm!

The below lines were added to the init scripts:

```bash
mkdir -p /overlay
mount -t squashfs /cdrom/casper/ubuntu.overlay /overlay
mount -t overlayfs -o lowerdir=/filesystem.squashfs,upperdir=/overlay overlayfs /
```

Note that `filesystem.squashfs` above is a directory created by casper, not a file.

These three statements create an `/overlay` directory, mount a squashfs filesystem on the `/overlay` directory and then use OverlayFS to essentially merge the contents of `/overlay` over `/`.


### Example 2: transparent merging of two directories

In the process of re-building a live USB for each Linux XXX distro release is based on OverlayFS to save a bunch of time. Taking a directory called `ubuntu-base` which the initial deployment (the ubuntu-core image). Then directories named `ubuntu`, `kubuntu`, `lubuntu`, and `xubuntu` will be created (one for each different overlay).

Then, use OverlayFS to make the files from the `ubuntu-base` show up in the individual directories:

```bash
mount -t overlayfs -o lowerdir=ubuntu-base,upperdir=kubuntu overlayfs kubuntu
```

This makes the files from `ubuntu-base` show up in the `kubuntu` folder. To enter the overflays, chroot into the kubuntu folder and do something like:

```
apt-get install kubuntu-desktop
```

Any changes that are made while in this OverlayFS mount will remain in the upper directory (in this case the `kubuntu` folder). Then, once I unmount the OverlayFS mount the files that really exist in ubuntu-base but are *mirrored* into the kubuntu folder vanish unless they have been changed. This keeps me from having to have multiple copies of the files in ubuntu-base while still being able to use them as if they physically exist in each location.


### Exploit

[overlayfs.c](./overlayfs.c)

Testbed:

```bash
$ uname -a
Linux panoramabar 3.16.0-57-generic #77~14.04.1-Ubuntu SMP Thu Dec 17 23:20:00 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux
$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 14.04.3 LTS
Release:        14.04
Codename:       trusty
$ cat /etc/issue
Ubuntu 14.04.3 LTS \n \l
```

Compilation and execution:

```bash
$ gcc -Wall overlayfs.c -o overlayfs
$ ./overlayfs 
mount failed..
couldn't create suid :(
```

```bash
$ gcc -o overlayfs overlayfs.c 
$ vim overlayfs.c 
$ ./overlayfs 
mount failed..
couldn't create suid :(
$ uname -a
Linux panoramabar 3.16.0-57-generic #77~14.04.1-Ubuntu SMP Thu Dec 17 23:20:00 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux
```
